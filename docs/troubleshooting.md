# トラブルシューティング

NextDesign Mermaid Converterで発生する可能性のある問題と解決方法を説明します。

## 目次

1. [インストール関連](#インストール関連)
2. [エクスポート関連](#エクスポート関連)
3. [インポート関連](#インポート関連)
4. [ファイル関連](#ファイル関連)
5. [パフォーマンス関連](#パフォーマンス関連)
6. [デバッグ方法](#デバッグ方法)

## インストール関連

### 問題: リボンタブに「Mermaid変換」が表示されない

**原因:**
- エクステンションが正しくインストールされていない
- manifest.jsonにエラーがある
- Next Designが古いバージョン

**解決方法:**

1. **インストールパスを確認**
   ```
   %USERPROFILE%\Documents\NextDesign\Extensions\MermaidConverter\
   ```
   以下のファイルが存在することを確認:
   - `manifest.json`
   - `main.cs`

2. **manifest.jsonの構文を確認**
   - JSONとして有効か確認 (JSONバリデーターを使用)
   - 必須フィールドがすべて存在するか確認

3. **Next Designのバージョンを確認**
   - Next Design 3.0以降が必要
   - メニュー「ヘルプ」→「バージョン情報」で確認

4. **Next Designを完全に再起動**
   - プロセスが完全に終了していることを確認
   - タスクマネージャーで確認

5. **出力ウィンドウでエラーを確認**
   - メニュー「表示」→「出力」
   - エクステンション読み込みエラーがないか確認

### 問題: エクステンションは読み込まれているがボタンが動作しない

**原因:**
- main.csにコンパイルエラーがある
- 関数名がmanifest.jsonと一致していない

**解決方法:**

1. **関数名の一致を確認**
   
   manifest.json:
   ```json
   "execFunc": "ExportToMermaid"
   ```
   
   main.cs:
   ```csharp
   public void ExportToMermaid(ICommandContext context, ICommandParams parameters)
   ```

2. **シグネチャの確認**
   - 必ず `public void` で定義
   - 引数は `ICommandContext, ICommandParams` の順

3. **出力ウィンドウでエラーを確認**

## エクスポート関連

### 問題: 「モデルが選択されていません」エラー

**原因:**
- シーケンス図が選択されていない
- エディタでシーケンス図が開かれていない

**解決方法:**

1. **シーケンス図を開く**
   - ナビゲータでシーケンス図を選択
   - ダブルクリックでエディタを開く

2. **エディタがアクティブか確認**
   - シーケンス図エディタのタブがアクティブであることを確認

### 問題: エクスポートされたファイルが空または不完全

**原因:**
- シーケンス図にライフラインやメッセージがない
- Next Design APIのアクセスエラー

**解決方法:**

1. **シーケンス図の内容を確認**
   - ライフラインが定義されているか
   - メッセージが定義されているか

2. **出力ウィンドウでログを確認**
   ```
   メニュー「表示」→「出力」
   チャンネル: mermaid-converter
   ```

3. **詳細ログの確認**
   - "ライフライン数: X"
   - "メッセージ数: Y"
   - エラーメッセージの確認

### 問題: 日本語が文字化けする

**原因:**
- エンコーディングがUTF-8でない
- テキストエディタがShift-JISなどで開いている

**解決方法:**

1. **UTF-8エンコーディングで開く**
   - VS Code: 右下の「エンコーディング」→「UTF-8で再度開く」
   - Notepad++: 「エンコード」→「UTF-8に変換」

2. **BOM なしのUTF-8を使用**
   - BOMありのUTF-8は一部のツールで問題が発生する可能性

### 問題: メッセージの順序が期待と異なる

**原因:**
- メッセージのY座標でソートされている
- 視覚的な順序とデータ上の順序が異なる

**解決方法:**

1. **Next Designでメッセージの順序を確認**
   - シーケンス図エディタで上から順に確認

2. **メタデータファイルの順序を確認**
   - messages[].order フィールドを確認

3. **手動で順序を調整**
   - メタデータファイルのorder値を編集
   - または、Next Designでメッセージを並び替え

## インポート関連

### 問題: 「プロジェクトまたはモデルを開いてください」エラー

**原因:**
- Next Designでプロジェクトが開かれていない

**解決方法:**

1. **プロジェクトを開く**
   - メニュー「ファイル」→「プロジェクトを開く」
   - または、既存のプロジェクトを選択

### 問題: インポートが失敗する (構文エラー)

**原因:**
- Mermaidファイルの構文が正しくない
- サポートされていない構文が含まれている

**解決方法:**

1. **検証機能を使用**
   - リボンタブ「Mermaid変換」→「Mermaid検証」
   - エラー箇所を確認

2. **Mermaid Live Editorで確認**
   - https://mermaid.live/ にアクセス
   - ファイル内容をペースト
   - 構文エラーを確認

3. **一般的な構文エラー**
   
   **エラー例1: participantのスペルミス**
   ```mermaid
   partcipant A  # NG
   participant A # OK
   ```
   
   **エラー例2: 矢印の誤り**
   ```mermaid
   A->B: text   # NG (矢印が短い)
   A->>B: text  # OK
   ```
   
   **エラー例3: ライフライン未定義**
   ```mermaid
   sequenceDiagram
       A->>B: text  # NG (AとBが未定義)
   ```
   
   ```mermaid
   sequenceDiagram
       participant A
       participant B
       A->>B: text  # OK
   ```

### 問題: メタデータファイルが読み込まれない

**原因:**
- メタデータファイルの命名規則が正しくない
- JSONの構文エラー

**解決方法:**

1. **命名規則を確認**
   - Mermaidファイル: `example.mmd`
   - メタデータファイル: `example.meta.json`
   - 同じフォルダに配置

2. **JSONの構文を確認**
   - JSONバリデーター (https://jsonlint.com/) で確認
   - カンマの位置、括弧の対応を確認

3. **手動でメタデータを指定** (将来機能)
   - 現在は自動検出のみ

### 問題: インポート後、シーケンス図が見つからない

**原因:**
- インポートは成功したが、表示されていない
- 別のモデル階層に作成された

**解決方法:**

1. **ナビゲータで検索**
   - ナビゲータの検索機能を使用
   - インポートしたダイアグラム名で検索

2. **モデル階層を確認**
   - 現在選択されているモデルの配下に作成される

3. **出力ウィンドウで確認**
   - "インポート完了" メッセージを確認
   - 作成されたダイアグラムのIDをログで確認

## ファイル関連

### 問題: ファイルが開けない・保存できない

**原因:**
- ファイルパスに問題がある
- アクセス権限がない
- ファイルが他のプログラムで開かれている

**解決方法:**

1. **ファイルパスを確認**
   - 特殊文字が含まれていないか
   - パスの長さが長すぎないか (Windows: 260文字制限)

2. **アクセス権限を確認**
   - フォルダの読み取り/書き込み権限
   - 管理者権限が必要な場所ではないか

3. **ファイルロックを確認**
   - 他のアプリケーションでファイルが開かれていないか
   - プロセスエクスプローラーで確認

### 問題: メタデータファイルが壊れている

**原因:**
- エクスポート途中でエラーが発生した
- 手動編集でJSONが破損した

**解決方法:**

1. **再エクスポート**
   - Next Designから再度エクスポート

2. **JSONを修復**
   - JSONバリデーターでエラー箇所を特定
   - 手動で修正

3. **メタデータなしでインポート**
   - メタデータファイルを削除または名前変更
   - Mermaidファイルのみでインポート

## パフォーマンス関連

### 問題: エクスポートに時間がかかる

**原因:**
- シーケンス図が非常に大きい (ライフライン50+, メッセージ500+)
- ファイルI/Oのパフォーマンス

**解決方法:**

1. **シーケンス図を分割**
   - 複数の小さなシーケンス図に分割

2. **高速なストレージを使用**
   - SSDに保存

3. **ログレベルを下げる** (将来機能)

### 問題: インポートに時間がかかる

**原因:**
- Mermaidファイルが非常に大きい
- 複雑なフラグメント構造

**解決方法:**

1. **ファイルを分割**
   - 複数の小さなファイルに分割

2. **トランザクション最適化** (将来改善予定)

## デバッグ方法

### ログの確認

1. **出力ウィンドウを開く**
   ```
   メニュー「表示」→「出力」
   ```

2. **チャンネルを選択**
   ```
   チャンネル: mermaid-converter
   ```

3. **ログレベル**
   - `[INFO]`: 通常の処理
   - `[WARNING]`: 警告 (処理は継続)
   - `[ERROR]`: エラー (処理が失敗)

### 詳細ログの有効化

main.csの各処理で詳細ログを追加:

```csharp
LogInfo($"処理開始: {functionName}");
LogInfo($"ライフライン数: {lifelines.Count()}");
LogInfo($"メッセージ: {message.Name}, 送信元: {message.Sender?.Name}");
```

### トランザクションエラーのデバッグ

**エラー例:**
```
トランザクションが開始されていません
```

**確認事項:**
1. BeginTransaction が呼ばれているか
2. トランザクション中に別のトランザクションを開始していないか
3. 例外発生時に RollbackTransaction が呼ばれているか

**推奨パターン:**
```csharp
App.Workspace.BeginTransaction("操作名");
try
{
    // モデル変更処理
    
    App.Workspace.CommitTransaction();
    LogInfo("トランザクションコミット完了");
}
catch (Exception ex)
{
    App.Workspace.RollbackTransaction();
    LogError($"トランザクションロールバック: {ex.Message}");
    throw;
}
```

### APIアクセスエラーのデバッグ

**エラー例:**
```
Object reference not set to an instance of an object
```

**確認事項:**
1. APIが返す値がnullでないか確認
2. コレクションが空でないか確認
3. プロパティアクセス前にnullチェック

**推奨パターン:**
```csharp
// NGパターン
var name = message.Sender.Name; // Senderがnullの場合エラー

// OKパターン1: nullチェック
if (message.Sender != null)
{
    var name = message.Sender.Name;
}

// OKパターン2: null条件演算子
var name = message.Sender?.Name ?? "Unknown";

// OKパターン3: SafeGetProperty関数
var name = SafeGetProperty(message, m => m.Sender?.Name, "Unknown");
```

## よくあるエラーメッセージ

### "シーケンス図エディタが開かれていません"

**意味:** シーケンス図がエディタで開かれていない

**解決:** シーケンス図をダブルクリックして開く

### "未定義のライフライン: XXX"

**意味:** メッセージで参照されているライフラインが定義されていない

**解決:** Mermaidファイルにparticipant XXXを追加

### "sequenceDiagramヘッダーが見つかりません"

**意味:** Mermaidファイルの最初に "sequenceDiagram" がない

**解決:** ファイルの最初の行に追加

### "メタデータファイルの形式が不正です"

**意味:** JSONの構文エラーまたは必須フィールドの欠落

**解決:** JSONバリデーターで確認・修正

## サポートリクエスト

上記で解決しない場合、以下の情報を含めてサポートリクエストを送信してください:

1. **環境情報**
   - Next Designのバージョン
   - Windowsのバージョン
   - エクステンションのバージョン

2. **再現手順**
   - 詳細な操作手順
   - 使用したファイル (可能であれば)

3. **エラー情報**
   - エラーメッセージ全文
   - 出力ウィンドウのログ
   - スクリーンショット

4. **期待される動作**
   - 本来どのように動作すべきか

## 関連ドキュメント

- [ユーザーガイド](user-guide.md)
- [開発者ガイド](developer-guide.md)
- [ファイル形式仕様](file-format.md)
- [Next Design公式サポート](https://docs.nextdesign.app/)
